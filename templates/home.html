{% extends "base.html" %}

{% block header %}
    👤 Home
{% endblock %}

{% block content %}
    <!-- Display header message based on current user -->
    <p>Search for user profiles by username.</p>

    <!-- Search Form -->
    <form method="POST" action="{{ url_for('home') }}">
        <label for="query_text">Sort by Query Relevance</label>
        <input type="text" name="query_text" value="{{ query_text }}"><br>
        
        <label for="query_user">Filter by User</label>
        <input type="text" name="query_user" value="{{ query_user }}"><br>

        <label for="query_category">Filter by Category</label>
        <input type="text" name="query_category" value="{{ query_category }}"><br>

        <button type="submit" name="search_users">Search</button>
    </form>
    
    <!-- Display User Profile Bubbles -->
    {% if relevant_bubbles %}
    <h3>Bubbles for User: {{ query_user }}</h3>
    <div class="bubble-list">
        {% for bubble in relevant_bubbles %}
        {% if bubble.user == user_name %}
            <div class="bubble-item bubble-item-mine">
                {% if bubble.category %}
                    <li>🎉 {{ bubble.content }} <i>in #{{ bubble.category }}</i> <br> <small>{{ bubble.created_at_str }}</small></li>
                {% else %}
                    <li>🎉 {{ bubble.content }} <br> <small>{{ bubble.created_at_str }}</small></li>
                {% endif %}
                
                <!-- If current user, show option to remove bubbles -->
                <form method="POST" class="delete-form">
                    <input type="hidden" name="bubble_id" value="{{ bubble.uuid }}">
                    <button type="submit" name="remove_bubble" class="delete-bubble">❌</button>
                </form>
            </div>
        {% else %}
            <div class="bubble-item">
                {% if bubble.category %}
                    <li>💭 {{ bubble.content }} <i>by @{{ bubble.user }} in #{{ bubble.category }}</i> <br> <small>{{ bubble.created_at_str }}</small></li>
                {% else %}
                    <li>💭 {{ bubble.content }} <i>by @{{ bubble.user }}</i> <br> <small>{{ bubble.created_at_str }}</small></li>
                {% endif %}
            </div>
        {% endif %}
        {% endfor %}
    </div>
    
    <!-- Pagination Controls -->
    <div class="pagination">
        {% if offset > 0 %}
        <a href="{{ url_for('home', query_user=query_user, query_text=query_text, query_category=query_category, offset=offset - limit) }}">⬅️ Previous</a>
        {% endif %}
        {% if has_more %}
        <a href="{{ url_for('home', query_user=query_user, query_text=query_text, query_category=query_category, offset=offset + limit) }}">Next ➡️</a>
        {% endif %}
    </div>
    {% endif %}

    <!-- Show extra options if the current user is viewing their own profile -->
    <!-- Create New Bubble Form -->
    <form method="POST" action="{{ url_for('home', query_user=query_user) }}">
        <label for="content">Blow a New Bubble:</label>
        <textarea name="content" placeholder="What's on your mind?"></textarea>
        <label for="category">Category:</label>
        <input type="text" name="category" placeholder="Category (optional)">
        <button type="submit" name="create_bubble" class="create-bubble">Blow Bubble 💭</button>
    </form>

    <p>Find other Bubblers who share similar thoughts and bubbles!</p>

    <!-- Rank Users Form -->

    <!-- Search Form -->
    <form method="POST" action="{{ url_for('home', query_user=query_user) }}">
        <label for="query_text_rank">Search Query (optional)💬</label>
        <input type="text" name="query_text_rank" value="{{ query_text_rank }}" placeholder="Type your search query">
        <label for="query_category_rank">Filter by Category (optional)</label>
        <input type="text" name="query_category_rank" value="{{ query_category_rank }}" placeholder="Filter by category (optional)">
        <button type="submit" name="rank_users">Find Bubblers 🫂</button>
    </form>

    <!-- Display Results -->
    {% if relevant_users_rank %}
    <h3>Here are some like-minded Bubblers 🎈</h3>
    <ul class="similar-users-list">
        {% for user in relevant_users_rank %}
        <li>
            <span>👤 {{ user.user }} (Similarity: {{ '%.2f' % (user.similarity * 100) }}%)</span>
        </li>
        {% endfor %}
    </ul>

    <!-- Pagination Controls -->
    <div class="pagination">
        {% if offset_rank > 0 %}
        <a href="{{ url_for('home', query_user=query_user, query_text_rank=query_text_rank, query_category_rank=query_category_rank, offset_rank=offset_rank - limit) }}">⬅️ Previous</a>
        {% endif %}
        {% if has_more_rank %}
        <a href="{{ url_for('home', query_user=query_user, query_text_rank=query_text_rank, query_category_rank=query_category_rank, offset_rank=offset_rank + limit) }}">Next ➡️</a>
        {% endif %}
    </div>
    {% else %}
    <p>No similar Bubblers found for your search. 🌈</p>
    {% endif %}
{% endblock %}
